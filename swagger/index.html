<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>API Docs</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@stoplight/elements/web-components.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stoplight/elements/styles.min.css"/>
  <style>
    .sl-bg-canvas {
      padding-left: 32px;
      padding-right: 32px;
    }

    [data-testid="two-column-right"] {
      margin-left: 0;
      max-width: 1200px !important;
      width: 100% !important;
      margin-right: 32px;
    }

    .sl-stack.sl-stack--vertical.sl-stack--8.HttpOperation.sl-flex.sl-flex-col.sl-items-stretch.sl-w-full > .sl-flex:nth-child(2) {
      flex-direction: column;

      .sl-w-0 {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<elements-api
  apiDescriptionUrl="./swagger.json"
  router="hash"
  layout="sidebar"
></elements-api>

<script>
  function generateObserver(data) {
    let timeout;
    let currentElements = []
    function insert(snippet, lines) {
      const firstLine = snippet.querySelector('.sl-flex');
      currentElements = lines.reverse().map(line => {
        const div = document.createElement('div');
        div.className = 'sl-flex extra-curl-line';
        div.innerHTML = `<div class="sl-flex-1 sl-break-all">${line}</div>`;
        firstLine.after(div);
        return div;
      });
    }

    function deleteEl() {
      currentElements.forEach(line => line.parentNode.removeChild(line));
      currentElements = []
    }

    return function patchCurlSnippets() {

      const snippet = document.querySelector(`.sl-code-highlight.prism-code:not(.language-json)`);
      if (!snippet) {
        return
      }
      if (timeout) {
        clearTimeout(timeout);
      }

      timeout = setTimeout(() => {
        let textContent = document.querySelector('[aria-label="Request Sample Language"]');
        if (!textContent) {
          return
        }
        textContent = textContent.textContent.toLowerCase();
        const matchedLang = Object.keys(data).find(lang => textContent.includes(lang));
        if (matchedLang && snippet.dataset.lang) {
          if (snippet.dataset.lang === matchedLang) {
            console.log(`Matched with supporting lang ${matchedLang}, but already latest patch`);
          } else {
            snippet.dataset.lang = matchedLang;
            deleteEl();
            insert(snippet, data[matchedLang].elements);
            console.log(`Matched anther supporting lang ${matchedLang},remove old, apply new`);
          }
        } else if (matchedLang && !snippet.dataset.lang) {
          snippet.dataset.lang  = matchedLang;
          insert(snippet, data[matchedLang].elements);
          console.log(`Matched with ${matchedLang}, first patch required`);
        } else if (!matchedLang && !snippet.dataset.lang) {
          console.log("Current lang not support, it's not patched, nothing required ");
        } else if (!matchedLang && snippet.dataset.lang) {
          snippet.removeAttribute(`data-lang`);
          deleteEl();
          console.log("Change patch required due to not supporting lang");
        }
      }, 100)
    }
  }

  // Watch for dynamic updates AND subtree changes
  const observer = new MutationObserver(generateObserver(
    {
      'curl': {
        elements: [
          '  --cert cert.pem \\',
          '  --key key.pem \\',
          '  --cacert ca-cert.pem \\',
          '  --insecure \\'
        ]
      },
      'node / native': {
        elements: [
          "let agent= new Agent({",
          "  cert: await readFile('./gencert/client/cert.pem', 'utf8'),",
          "  key: await readFile('./gencert/client/key.pem', 'utf8'),",
          "  ca: await readFile('./gencert/client/ca-cert.pem', 'utf8'),",
          "  rejectUnauthorized: true, // force to fail upon wrong public keys",
          "  checkServerIdentity: () => undefined, // we don't care about domain name, since we rely on PK in mtls",
          "});"
        ]
      }
    },
  ));
  observer.observe(document.body, {childList: true, subtree: true, characterData: true});

</script>

</body>
</html>
